@page "/"

@using Interfaces.WeatherDataAccessLibrary
@using WeatherApp.Common.Models

@inject ISqlDataAccess SqlDataAccess;
@inject ISqlQueries SqlQueries;


<h1>Weather Forecast for Bratislava</h1>
@if (_weatherData == null) 
{
    <h4>Loading...</h4>
}
else
{
    <table class="table">
        <thead>
        <tr>
            <th>Date</th>
            <th>Temp</th>
            <th>Pressure</th>
            <th>Humidity</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var data in _weatherData)
        {
            <tr>
                <td>@data.Date.ToString("HH:mm")</td>
                <td>@Math.Ceiling(data.Temp)</td>
                <td>@data.Pressure</td>
                <td>@data.Humidity%</td>
            </tr>
        }
        </tbody>
    </table>

}



@code
{

    private List<WeatherModel> _weatherData;

    protected override async Task OnInitializedAsync()
    {
        _weatherData = await SqlQueries.GetTodayWeather();
        await SqlDataAccess.ReceiveNotify();
        SqlDataAccess.OnWeatherChange += SqlDataAccessOnOnWeatherChange;
    }

    private async void SqlDataAccessOnOnWeatherChange(object? sender, WeatherModel e)
    {
        _weatherData.Add(e);
        
        await InvokeAsync(() =>
        {
            base.StateHasChanged();
        });
    }
}
